import{r as e,h as a,U as l,B as s,z as o,C as t,E as n,D as i,ak as r,ag as u,K as d,P as c,a4 as m,y as v,M as p,O as y,u as f,G as g,n as w}from"./vue-vendor-CYJ4K8iR.js";import{_ as h}from"./index-CT3p-j8z.js";import{F as k,E as _}from"./element-plus-dcQV5w3x.js";import"./mermaid-BoZA0hCz.js";const C={class:"tool-container"},V={key:0,class:"room-list-view"},b={class:"tool-header"},j={class:"actions"},P={class:"join-section"},S={class:"room-list"},I={key:0,class:"empty-tip"},U=["onClick"],$={class:"room-info"},O={class:"room-name"},x={class:"room-id"},D={key:1,class:"chat-view"},T={class:"chat-header"},E={class:"room-title"},N={class:"room-id-tag"},z={key:0,class:"system-text"},J={class:"message-header"},W={class:"nickname"},F={class:"time"},B={class:"message-content"},K=["src","onClick"],M=["src"],A={class:"input-area"},H={class:"emoji-panel"},L=["onClick"],R=h({__name:"ChatRoom",setup(h){const R=e([]),G=e(null),q=e([]),Q=e(""),X=e(""),Y=e(""),Z=e(!1),ee=e(!1),ae=e(!1),le=e(!1),se=e(!1),oe=e(!1),te=e(!1),ne=e(""),ie=e({name:"",password:""}),re=e({nickname:"",password:"",needPassword:!1,roomId:""}),ue=e(null),de=e(null),ce=e(null);let me=null;const ve=["ðŸ˜€","ðŸ˜","ðŸ˜‚","ðŸ¤£","ðŸ˜ƒ","ðŸ˜„","ðŸ˜…","ðŸ˜†","ðŸ˜‰","ðŸ˜Š","ðŸ˜‹","ðŸ˜Ž","ðŸ˜","ðŸ¥°","ðŸ˜˜","ðŸ˜—","ðŸ˜™","ðŸ˜š","ðŸ™‚","ðŸ¤—","ðŸ¤”","ðŸ˜","ðŸ˜‘","ðŸ˜¶","ðŸ™„","ðŸ˜","ðŸ˜£","ðŸ˜¥","ðŸ˜®","ðŸ¤","ðŸ˜¯","ðŸ˜ª","ðŸ˜«","ðŸ˜´","ðŸ˜Œ","ðŸ˜›","ðŸ˜œ","ðŸ˜","ðŸ¤¤","ðŸ˜’","ðŸ˜“","ðŸ˜”","ðŸ˜•","ðŸ™ƒ","ðŸ¤‘","ðŸ˜²","ðŸ™","ðŸ˜–","ðŸ˜ž","ðŸ˜Ÿ","ðŸ˜¤","ðŸ˜¢","ðŸ˜­","ðŸ˜¦","ðŸ˜§","ðŸ˜¨","ðŸ˜©","ðŸ¤¯","ðŸ˜¬","ðŸ˜°","ðŸ‘","ðŸ‘Ž","ðŸ‘","ðŸ™Œ","ðŸ¤","â¤ï¸","ðŸ”¥","â­","ðŸŽ‰","ðŸ’¯"],pe=async()=>{try{const e=await fetch("/api/chat/rooms"),a=await e.json();R.value=a.rooms||[]}catch(e){}},ye=async()=>{if(ie.value.name.trim()){le.value=!0;try{const e=await fetch("/api/chat/room",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(ie.value)}),a=await e.json();if(!e.ok)throw new Error(a.error||"åˆ›å»ºå¤±è´¥");_.success("æˆ¿é—´åˆ›å»ºæˆåŠŸ"),Z.value=!1,ie.value={name:"",password:""},re.value={nickname:"",password:ie.value.password,needPassword:!1,roomId:a.id},ee.value=!0,pe()}catch(e){_.error(e.message)}finally{le.value=!1}}else _.warning("è¯·è¾“å…¥æˆ¿é—´åç§°")},fe=async()=>{if(Y.value.trim())try{const e=await fetch(`/api/chat/room/${Y.value}`),a=await e.json();if(!e.ok)throw new Error(a.error||"æˆ¿é—´ä¸å­˜åœ¨");re.value={nickname:X.value||"",password:"",needPassword:a.has_password,roomId:Y.value},ee.value=!0}catch(e){_.error(e.message)}else _.warning("è¯·è¾“å…¥æˆ¿é—´ID")},ge=async()=>{if(re.value.nickname.trim()){se.value=!0;try{const e=await fetch(`/api/chat/room/${re.value.roomId}/join`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({nickname:re.value.nickname,password:re.value.password})}),a=await e.json();if(!e.ok)throw new Error(a.error||"åŠ å…¥å¤±è´¥");X.value=re.value.nickname,G.value=a.room,q.value=(a.messages||[]).map(e=>({...e,type:"message"})),ee.value=!1,we(),w(()=>{Se()})}catch(e){_.error(e.message)}finally{se.value=!1}}else _.warning("è¯·è¾“å…¥æ˜µç§°")},we=()=>{const e=`${"https:"===window.location.protocol?"wss:":"ws:"}//${window.location.host}/api/chat/room/${G.value.id}/ws?nickname=${encodeURIComponent(X.value)}`;me=new WebSocket(e),me.onopen=()=>{},me.onmessage=e=>{try{const a=JSON.parse(e.data);q.value.push(a),w(()=>{Se()})}catch(a){}},me.onclose=()=>{G.value&&setTimeout(()=>{G.value&&we()},3e3)},me.onerror=e=>{}},he=()=>{Q.value.trim()&&me&&(me.send(JSON.stringify({type:"message",content:Q.value.trim()})),Q.value="")},ke=()=>{de.value?.click()},_e=e=>{const a=e.target.files?.[0];a&&je(a,"image"),e.target.value=""},Ce=()=>{ce.value?.click()},Ve=e=>{const a=e.target.files?.[0];a&&je(a,"video"),e.target.value=""},be=e=>{const a=e.clipboardData?.items;if(a)for(const l of a){if(l.type.startsWith("image/")){e.preventDefault();const a=l.getAsFile();return void(a&&je(a,"image"))}if(l.type.startsWith("video/")){e.preventDefault();const a=l.getAsFile();return void(a&&je(a,"video"))}}},je=async(e,a)=>{const l="image"===a,s=l?5242880:52428800,o=l?"5MB":"50MB",t=l?"å›¾ç‰‡":"è§†é¢‘";if(e.size>s)return void _.error(`${t}å¤§å°ä¸èƒ½è¶…è¿‡ ${o}`);const n=l?"image/":"video/";if(e.type.startsWith(n)){oe.value=!0;try{const l=new FormData;l.append("image",e);const s=await fetch("/api/chat/upload",{method:"POST",body:l}),o=await s.json();if(!s.ok)throw new Error(o.error||"ä¸Šä¼ å¤±è´¥");me&&me.readyState===WebSocket.OPEN&&(me.send(JSON.stringify({type:"message",content:o.url,msg_type:o.type||a})),_.success(`${t}å‘é€æˆåŠŸ`))}catch(i){_.error(i.message||`${t}ä¸Šä¼ å¤±è´¥`)}finally{oe.value=!1}}else _.error(`åªæ”¯æŒ${t}æ–‡ä»¶`)},Pe=()=>{me&&(me.close(),me=null),G.value=null,q.value=[],pe()},Se=()=>{ue.value&&(ue.value.scrollTop=ue.value.scrollHeight)},Ie=e=>{if(!e)return"";return new Date(e).toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})};return a(()=>{pe()}),l(()=>{me&&(me.close(),me=null)}),(e,a)=>{const l=r("Plus"),w=r("el-icon"),h=r("el-button"),_=r("el-input"),me=r("Lock"),pe=r("House"),we=r("Sugar"),je=r("el-popover"),Se=r("Picture"),Ue=r("VideoCamera"),$e=r("el-form-item"),Oe=r("el-form"),xe=r("el-dialog");return o(),s("div",C,[G.value?(o(),s("div",D,[n("div",T,[n("div",E,[G.value.has_password?(o(),v(w,{key:0},{default:i(()=>[t(me)]),_:1})):(o(),v(w,{key:1},{default:i(()=>[t(pe)]),_:1})),p(" "+y(G.value.name)+" ",1),n("span",N,y(G.value.id),1)]),t(h,{onClick:Pe,type:"danger",size:"small"},{default:i(()=>[...a[18]||(a[18]=[p("é€€å‡º",-1)])]),_:1})]),n("div",{class:"messages-container",ref_key:"messagesContainer",ref:ue},[(o(!0),s(c,null,m(q.value,e=>(o(),s("div",{key:e.id||e.created_at,class:g(["message-item","system"===e.type?"system-message":e.nickname===X.value?"my-message":""])},["system"===e.type?(o(),s("span",z,y(e.content),1)):(o(),s(c,{key:1},[n("div",J,[n("span",W,y(e.nickname),1),n("span",F,y(Ie(e.created_at)),1)]),n("div",B,["image"===e.msg_type?(o(),s("img",{key:0,src:e.content,class:"message-image",onClick:a=>{return l=e.content,ne.value=l,void(te.value=!0);var l},loading:"lazy"},null,8,K)):"video"===e.msg_type?(o(),s("video",{key:1,src:e.content,class:"message-video",controls:"",preload:"metadata"},null,8,M)):(o(),s(c,{key:2},[p(y(e.content),1)],64))])],64))],2))),128))],512),n("div",A,[t(je,{placement:"top-start",width:320,trigger:"click",visible:ae.value,"onUpdate:visible":a[2]||(a[2]=e=>ae.value=e)},{reference:i(()=>[t(h,{class:"emoji-btn"},{default:i(()=>[t(w,null,{default:i(()=>[t(we)]),_:1})]),_:1})]),default:i(()=>[n("div",H,[(o(),s(c,null,m(ve,e=>n("span",{key:e,class:"emoji-item",onClick:a=>(e=>{Q.value+=e,ae.value=!1})(e)},y(e),9,L)),64))])]),_:1},8,["visible"]),t(h,{class:"image-btn",onClick:ke,loading:oe.value},{default:i(()=>[t(w,null,{default:i(()=>[t(Se)]),_:1})]),_:1},8,["loading"]),t(h,{class:"video-btn",onClick:Ce,loading:oe.value},{default:i(()=>[t(w,null,{default:i(()=>[t(Ue)]),_:1})]),_:1},8,["loading"]),n("input",{type:"file",ref_key:"imageInput",ref:de,accept:"image/*",style:{display:"none"},onChange:_e},null,544),n("input",{type:"file",ref_key:"videoInput",ref:ce,accept:"video/*",style:{display:"none"},onChange:Ve},null,544),t(_,{modelValue:Q.value,"onUpdate:modelValue":a[3]||(a[3]=e=>Q.value=e),placeholder:"è¾“å…¥æ¶ˆæ¯ï¼Œå¯ç²˜è´´å›¾ç‰‡æˆ–è§†é¢‘...",onKeyup:u(he,["enter"]),onPaste:be,class:"message-input"},null,8,["modelValue"]),t(h,{type:"primary",onClick:he,disabled:!Q.value.trim()},{default:i(()=>[...a[19]||(a[19]=[p(" å‘é€ ",-1)])]),_:1},8,["disabled"])]),te.value?(o(),v(f(k),{key:0,"url-list":[ne.value],onClose:a[4]||(a[4]=e=>te.value=!1)},null,8,["url-list"])):d("",!0)])):(o(),s("div",V,[n("div",b,[a[14]||(a[14]=n("h2",null,"èŠå¤©å®¤",-1)),n("div",j,[t(h,{type:"primary",onClick:a[0]||(a[0]=e=>Z.value=!0)},{default:i(()=>[t(w,null,{default:i(()=>[t(l)]),_:1}),a[13]||(a[13]=p(" åˆ›å»ºæˆ¿é—´ ",-1))]),_:1})])]),n("div",P,[t(_,{modelValue:Y.value,"onUpdate:modelValue":a[1]||(a[1]=e=>Y.value=e),placeholder:"è¾“å…¥æˆ¿é—´IDç›´æŽ¥åŠ å…¥",class:"join-input",onKeyup:u(fe,["enter"])},{append:i(()=>[t(h,{onClick:fe},{default:i(()=>[...a[15]||(a[15]=[p("åŠ å…¥",-1)])]),_:1})]),_:1},8,["modelValue"])]),n("div",S,[a[17]||(a[17]=n("div",{class:"section-title"},"å…¬å¼€æˆ¿é—´",-1)),0===R.value.length?(o(),s("div",I,"æš‚æ— æˆ¿é—´ï¼Œåˆ›å»ºä¸€ä¸ªå§")):d("",!0),(o(!0),s(c,null,m(R.value,e=>(o(),s("div",{key:e.id,class:"room-item",onClick:a=>(e=>{re.value={nickname:X.value||"",password:"",needPassword:e.has_password,roomId:e.id},ee.value=!0})(e)},[n("div",$,[n("span",O,[e.has_password?(o(),v(w,{key:0},{default:i(()=>[t(me)]),_:1})):(o(),v(w,{key:1},{default:i(()=>[t(pe)]),_:1})),p(" "+y(e.name),1)]),n("span",x,"ID: "+y(e.id),1)]),t(h,{type:"primary",size:"small"},{default:i(()=>[...a[16]||(a[16]=[p("è¿›å…¥",-1)])]),_:1})],8,U))),128))])])),t(xe,{modelValue:Z.value,"onUpdate:modelValue":a[8]||(a[8]=e=>Z.value=e),title:"åˆ›å»ºæˆ¿é—´",width:"400px"},{footer:i(()=>[t(h,{onClick:a[7]||(a[7]=e=>Z.value=!1)},{default:i(()=>[...a[20]||(a[20]=[p("å–æ¶ˆ",-1)])]),_:1}),t(h,{type:"primary",onClick:ye,loading:le.value},{default:i(()=>[...a[21]||(a[21]=[p("åˆ›å»º",-1)])]),_:1},8,["loading"])]),default:i(()=>[t(Oe,{model:ie.value,"label-width":"80px"},{default:i(()=>[t($e,{label:"æˆ¿é—´åç§°"},{default:i(()=>[t(_,{modelValue:ie.value.name,"onUpdate:modelValue":a[5]||(a[5]=e=>ie.value.name=e),placeholder:"è¯·è¾“å…¥æˆ¿é—´åç§°",maxlength:"50"},null,8,["modelValue"])]),_:1}),t($e,{label:"å¯†é’¥"},{default:i(()=>[t(_,{modelValue:ie.value.password,"onUpdate:modelValue":a[6]||(a[6]=e=>ie.value.password=e),type:"password",placeholder:"å¯é€‰ï¼Œç•™ç©ºä¸ºå…¬å¼€æˆ¿é—´","show-password":""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(xe,{modelValue:ee.value,"onUpdate:modelValue":a[12]||(a[12]=e=>ee.value=e),title:"åŠ å…¥æˆ¿é—´",width:"400px"},{footer:i(()=>[t(h,{onClick:a[11]||(a[11]=e=>ee.value=!1)},{default:i(()=>[...a[22]||(a[22]=[p("å–æ¶ˆ",-1)])]),_:1}),t(h,{type:"primary",onClick:ge,loading:se.value},{default:i(()=>[...a[23]||(a[23]=[p("åŠ å…¥",-1)])]),_:1},8,["loading"])]),default:i(()=>[t(Oe,{model:re.value,"label-width":"80px"},{default:i(()=>[t($e,{label:"æ˜µç§°"},{default:i(()=>[t(_,{modelValue:re.value.nickname,"onUpdate:modelValue":a[9]||(a[9]=e=>re.value.nickname=e),placeholder:"è¯·è¾“å…¥æ˜µç§°",maxlength:"20"},null,8,["modelValue"])]),_:1}),re.value.needPassword?(o(),v($e,{key:0,label:"å¯†é’¥"},{default:i(()=>[t(_,{modelValue:re.value.password,"onUpdate:modelValue":a[10]||(a[10]=e=>re.value.password=e),type:"password",placeholder:"è¯·è¾“å…¥æˆ¿é—´å¯†é’¥","show-password":""},null,8,["modelValue"])]),_:1})):d("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},[["__scopeId","data-v-1432677d"]]);export{R as default};
